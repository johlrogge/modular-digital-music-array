name: Build SD Card Images

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags
  workflow_dispatch:  # Allow manual triggers

permissions:
  contents: write  # Needed to create releases

jobs:
  build-image:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libguestfs-tools \
          wget \
          xz-utils
    
    - name: Install xbps tools
      run: |
        wget -q https://repo-default.voidlinux.org/static/xbps-static-latest.x86_64-musl.tar.xz
        sudo tar -xf xbps-static-latest.x86_64-musl.tar.xz -C /usr/local --strip-components=2
        sudo chmod +x /usr/local/bin/xbps*
        xbps-rindex --version
    
    - name: Create SD card image
      env:
        ONLINE_REPO: https://johlrogge.github.io/modular-digital-music-array/packages/aarch64
        VOID_IMAGE_URL: https://repo-default.voidlinux.org/live/current/void-rpi5-aarch64-20250202.img.xz
      run: |
        mkdir -p images
        
        # Download base image
        echo "ðŸ“¥ Downloading Void Linux base..."
        wget -O void-base.img.xz "$VOID_IMAGE_URL"
        xz -dc void-base.img.xz > void-base.img
        
        # Create working copy
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        cp void-base.img mdma-beacon.img
        
        # Find root partition
        echo "ðŸ” Finding root partition..."
        ROOTFS_DEV=$(guestfish --ro -a mdma-beacon.img run : list-filesystems | grep ext4 | head -1 | cut -d: -f1)
        echo "Found: $ROOTFS_DEV"
        
        # Mount and configure
        echo "ðŸ“‚ Mounting image..."
        mkdir -p mnt
        sudo guestmount -a mdma-beacon.img -m "$ROOTFS_DEV" --rw mnt
        
        # Configure repository
        echo "ðŸŒ Configuring online repository..."
        sudo bash -c "cat > mnt/etc/xbps.d/10-mdma-repo.conf" <<EOF
        repository=$ONLINE_REPO
        EOF
        sudo bash -c "cat > mnt/etc/xbps.d/00-repository-main.conf" <<EOF
        repository=https://repo-default.voidlinux.org/current/aarch64
        EOF
        
        # Update xbps
        echo "ðŸ“¦ Updating xbps..."
        sudo xbps-install -r mnt -Suy xbps
        
        # Install beacon (allowing unsigned packages)
        echo "ðŸ“¦ Installing beacon..."
        sudo XBPS_ALLOW_UNSIGNED=yes xbps-install -r mnt -Sy beacon
        
        # Enable services
        echo "ðŸ”§ Enabling services..."
        sudo ln -sf /etc/sv/beacon mnt/var/service/beacon || true
        sudo ln -sf /etc/sv/dbus mnt/var/service/dbus || true
        sudo ln -sf /etc/sv/avahi-daemon mnt/var/service/avahi-daemon || true
        
        # Unmount
        echo "ðŸ’¾ Unmounting..."
        sudo guestunmount mnt
        
        # Compress
        echo "ðŸ—œï¸  Compressing..."
        xz -z -9 -T 0 mdma-beacon.img
        
        # Move to images directory
        mv mdma-beacon.img.xz images/mdma-beacon-${TIMESTAMP}-rpi5.img.xz
        
        # Create latest symlink
        cd images
        ln -sf mdma-beacon-${TIMESTAMP}-rpi5.img.xz mdma-beacon-latest-rpi5.img.xz
        
        echo "âœ… Image created!"
        ls -lh
    
    - name: Generate checksums
      run: |
        cd images
        sha256sum *.img.xz > SHA256SUMS
        cat SHA256SUMS
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sd-card-images
        path: images/
        retention-days: 90
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          images/*.img.xz
          images/SHA256SUMS
        body: |
          ## MDMA Beacon SD Card Image
          
          ### What's Included
          - Void Linux base (Raspberry Pi 5)
          - MDMA Beacon provisioning system
          - Auto-starts on boot
          - Serves web interface at `welcome-to-mdma.local`
          
          ### How to Flash
          
          ```bash
          # Download the image
          wget https://github.com/johlrogge/modular-digital-music-array/releases/download/${{ github.ref_name }}/mdma-beacon-latest-rpi5.img.xz
          
          # Flash to SD card (replace /dev/sdX with your SD card device)
          xz -dc mdma-beacon-latest-rpi5.img.xz | sudo dd of=/dev/sdX bs=4M status=progress conv=fsync
          
          # Verify checksum
          sha256sum -c SHA256SUMS
          ```
          
          ### First Boot
          
          1. Insert SD card into Raspberry Pi 5
          2. Power on
          3. Wait ~30 seconds for boot
          4. Visit `http://welcome-to-mdma.local` in your browser
          5. Follow provisioning wizard
          
          ### Package Updates
          
          Beacon is installed from: https://johlrogge.github.io/modular-digital-music-array/packages/aarch64
          
          To update beacon on a running system:
          ```bash
          sudo xbps-install -Su beacon
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
